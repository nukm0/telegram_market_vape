<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vape Market | Барахолка для вейпов</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase скрипты -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* [Ваш CSS код остается полностью без изменений] */
        /* Фиолетовые градиенты для фона */
        :root {
            --gradient-primary: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 50%, #6D28D9 100%);
            --gradient-secondary: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 50%, #7C3AED 100%);
            --gradient-dark: linear-gradient(135deg, #6D28D9 0%, #5B21B6 50%, #4C1D95 100%);
            
            --button-primary: #7C3AED;
            --button-hover: #6D28D9;
            --button-active: #5B21B6;
            --button-success: #10B981;
            --button-error: #EF4444;
            --button-info: #3B82F6;
            --button-warning: #F59E0B;
            
            --text-light: #FFFFFF;
            --text-dark: #1F2937;
            --text-muted: #9CA3AF;
            
            --shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.3);
            --shadow-dark: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-bg-dark: rgba(30, 27, 75, 0.95);
        }
        
        /* Сброс стилей */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background: var(--gradient-primary);
            color: var(--text-light);
            transition: background 0.5s ease;
        }
        
        /* Контейнер приложения */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Шапка */
        .app-header {
            padding: 15px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .logo i {
            font-size: 24px;
            color: #A78BFA;
        }
        
        .logo span {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #FFFFFF, #E9D5FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Контент */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            margin-bottom: 10px;
        }
        
        /* Кнопка добавления объявления - ВМЕСТЕ С ФОРМОЙ СВЕРХУ */
        .add-ad-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .add-ad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .add-ad-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .toggle-form-btn {
            padding: 10px 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .toggle-form-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 10px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toggle-form-btn:hover::before {
            opacity: 1;
        }
        
        .toggle-form-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        
        /* Форма добавления объявления */
        .add-ad-form {
            display: none;
            margin-top: 20px;
        }
        
        .add-ad-form.active {
            display: block;
        }
        
        /* Категории */
        .categories {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 20px;
            scrollbar-width: none;
        }
        
        .categories::-webkit-scrollbar {
            display: none;
        }
        
        .category-btn {
            padding: 10px 20px;
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .category-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 23px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .category-btn:hover::before {
            opacity: 1;
        }
        
        .category-btn:hover {
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .category-btn.active {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
        }
        
        /* Объявление (товар + продавец вместе) */
        .advertisement-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        
        .advertisement-card:hover {
            transform: translateY(-2px);
        }
        
        /* Заголовок продавца */
        .seller-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .seller-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        .seller-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .seller-info {
            flex: 1;
        }
        
        .seller-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .seller-username {
            font-size: 14px;
            color: #D8B4FE;
            margin-bottom: 5px;
        }
        
        .seller-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }
        
        .seller-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .seller-stat i {
            font-size: 14px;
        }
        
        .stat-likes i { color: #10B981; }
        .stat-dislikes i { color: #EF4444; }
        .stat-rating i { color: #F59E0B; }
        
        /* Галерея фотографий товара */
        .photo-gallery {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 10px 0;
            min-height: 130px;
        }
        
        .photo-item {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
            position: relative;
            cursor: pointer;
        }
        
        .photo-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #A78BFA;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .photo-placeholder i {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-label {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            z-index: 2;
        }
        
        /* Информация о товаре */
        .product-info {
            margin-bottom: 15px;
        }
        
        .product-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
        }
        
        .product-category {
            display: inline-block;
            padding: 5px 12px;
            background: rgba(124, 58, 237, 0.4);
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .product-price {
            font-size: 24px;
            font-weight: 800;
            color: #10B981;
            margin-bottom: 15px;
        }
        
        .product-description {
            font-size: 14px;
            color: #D8B4FE;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        /* Круглые кнопки лайка/дизлайка */
        .action-grid {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .rate-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 24px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .rate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 50%;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .rate-btn:hover::before {
            opacity: 1;
        }
        
        .rate-btn:hover {
            transform: scale(1.1);
        }
        
        .rate-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .like-btn {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(16, 185, 129, 0.2) 100%);
            color: #10B981;
            border: 2px solid rgba(16, 185, 129, 0.5);
        }
        
        .like-btn:hover {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }
        
        .like-btn.active {
            background: linear-gradient(135deg, #10B981 0%, #0DA674 100%);
            color: white;
            border-color: #10B981;
        }
        
        .dislike-btn {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.2) 100%);
            color: #EF4444;
            border: 2px solid rgba(239, 68, 68, 0.5);
        }
        
        .dislike-btn:hover {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }
        
        .dislike-btn.active {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            border-color: #EF4444;
        }
        
        .contact-btn {
            flex: 2;
            padding: 16px;
            border-radius: 15px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .contact-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 13px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .contact-btn:hover::before {
            opacity: 1;
        }
        
        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        
        /* Форма добавления */
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .form-input::placeholder {
            color: #A78BFA;
        }
        
        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }
        
        /* Фото загрузка */
        .photo-upload-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
        }
        
        .upload-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.4) 0%, rgba(124, 58, 237, 0.3) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .upload-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 10px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .upload-btn:hover::before {
            opacity: 1;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .upload-info {
            font-size: 12px;
            color: #D8B4FE;
            text-align: center;
            margin-top: 10px;
        }
        
        /* Нижнее меню навигации */
        .bottom-nav {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 10px;
            margin-top: 5px;
            box-shadow: var(--shadow);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            border-radius: 12px;
            background: transparent;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 10px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .nav-item:hover::before {
            opacity: 1;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.3) 0%, rgba(124, 58, 237, 0.2) 100%);
        }
        
        .nav-item:hover {
            transform: translateY(-2px);
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }
        
        .nav-label {
            font-size: 11px;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }
        
        /* Страницы */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* Личный кабинет */
        .profile-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-info h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .profile-info p {
            font-size: 14px;
            color: #D8B4FE;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .profile-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #A78BFA;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #9CA3AF;
        }
        
        /* Вкладки в личном кабинете */
        .profile-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
        }
        
        .profile-tab.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.4) 0%, rgba(124, 58, 237, 0.3) 100%);
        }
        
        .profile-tab-content {
            display: none;
        }
        
        .profile-tab-content.active {
            display: block;
        }
        
        /* История просмотров */
        .history-list {
            margin-top: 20px;
        }
        
        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .history-info h4 {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .history-info p {
            font-size: 12px;
            color: #D8B4FE;
        }
        
        .remove-history-btn {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.2) 100%);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #EF4444;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Мои объявления */
        .my-ads-list {
            margin-top: 20px;
        }
        
        .my-ad-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .my-ad-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .my-ad-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        .my-ad-price {
            font-size: 18px;
            font-weight: 700;
            color: #10B981;
        }
        
        .my-ad-description {
            font-size: 14px;
            color: #D8B4FE;
            margin-bottom: 10px;
        }
        
        .my-ad-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .edit-ad-btn, .delete-ad-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .edit-ad-btn {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(59, 130, 246, 0.3) 100%);
        }
        
        .delete-ad-btn {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.4) 0%, rgba(239, 68, 68, 0.3) 100%);
        }
        
        /* FAQ страница */
        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .faq-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .faq-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        .faq-question {
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
        }
        
        .faq-answer {
            margin-top: 10px;
            color: #D8B4FE;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Статистика сервера */
        .server-stats {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .server-stats-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .server-stats-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .server-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .server-stat-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        
        .server-stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #A78BFA;
            display: block;
            margin-bottom: 5px;
        }
        
        .server-stat-label {
            font-size: 11px;
            color: #9CA3AF;
        }
        
        /* Кнопка жалобы */
        .complaint-btn {
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.2) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #EF4444;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .complaint-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 13px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .complaint-btn:hover::before {
            opacity: 1;
        }
        
        .complaint-btn:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.4) 0%, rgba(239, 68, 68, 0.3) 100%);
            transform: translateY(-2px);
        }
        
        /* Модальное окно для фото */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .photo-modal.active {
            display: flex;
        }
        
        .photo-modal-img {
            max-width: 90%;
            max-height: 70%;
            object-fit: contain;
            border-radius: 10px;
        }
        
        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .photo-modal-close:hover {
            transform: scale(1.1);
        }
        
        .photo-modal-counter {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
        
        .photo-modal-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
        }
        
        .photo-modal-nav-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .photo-modal-nav-btn:hover {
            transform: scale(1.1);
        }
        
        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transition: transform 0.5s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .notification.success {
            border-left: 4px solid #10B981;
        }
        
        .notification.error {
            border-left: 4px solid #EF4444;
        }
        
        .notification.info {
            border-left: 4px solid #3B82F6;
        }
        
        .notification.warning {
            border-left: 4px solid #F59E0B;
        }
        
        /* Скроллбар */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8B5CF6;
            border-radius: 10px;
        }
        
        /* Скрытый input для загрузки фото */
        .hidden-file-input {
            display: none;
        }
        
        /* Кнопки формы */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .publish-btn {
            flex: 2;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .publish-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 10px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .publish-btn:hover::before {
            opacity: 1;
        }
        
        .publish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        
        .cancel-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.2) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .cancel-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 10px;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .cancel-btn:hover::before {
            opacity: 1;
        }
        
        .cancel-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Стиль для заблокированных кнопок лайка/дизлайка */
        .rate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .rate-btn:disabled:hover {
            transform: none;
        }
        
        .rate-btn:disabled::before {
            display: none;
        }
        
        /* Стили для нескольких фотографий */
        .uploaded-photos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .uploaded-photo-item {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .uploaded-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-photo-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Синхронизация статус */
        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: #A78BFA;
            margin-top: 10px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10B981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ============ НОВЫЕ СТИЛИ ДЛЯ СИСТЕМЫ АДМИНИСТРИРОВАНИЯ ============ */
        
        /* Экран блокировки */
        .blocked-screen {
            text-align: center;
            padding: 40px 20px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 20px;
            border: 2px solid rgba(239, 68, 68, 0.3);
            margin: 20px 0;
        }
        
        .blocked-icon {
            font-size: 60px;
            color: #EF4444;
            margin-bottom: 20px;
        }
        
        .blocked-title {
            font-size: 24px;
            color: #EF4444;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .blocked-reason {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #EF4444;
        }
        
        .contact-admin-btn {
            padding: 15px 25px;
            border-radius: 12px;
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .contact-admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Кнопка жалобы на продавца */
        .report-seller-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            z-index: 10;
        }
        
        .report-seller-btn:hover {
            background: #EF4444;
            transform: scale(1.1);
        }
        
        /* Модальное окно жалобы */
        .complaint-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .complaint-modal.active {
            display: flex;
        }
        
        .complaint-modal-content {
            background: rgba(30, 27, 75, 0.95);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            border: 2px solid rgba(124, 58, 237, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .complaint-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .complaint-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }
        
        .complaint-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .complaint-form-group {
            margin-bottom: 20px;
        }
        
        .complaint-label {
            display: block;
            margin-bottom: 8px;
            color: #D8B4FE;
            font-size: 14px;
            font-weight: 600;
        }
        
        .complaint-select, .complaint-textarea {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 14px;
        }
        
        .complaint-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .complaint-priority {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .priority-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .priority-btn.active {
            border-color: currentColor;
        }
        
        .priority-low.active {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }
        
        .priority-medium.active {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }
        
        .priority-high.active {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }
        
        .complaint-screenshot {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .screenshot-btn {
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(124, 58, 237, 0.3);
            border: 1px solid rgba(124, 58, 237, 0.5);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .complaint-submit-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .complaint-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Админ панель */
        .admin-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(124, 58, 237, 0.5);
        }
        
        .admin-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(124, 58, 237, 0.5);
        }
        
        .admin-icon {
            font-size: 24px;
            color: #8B5CF6;
            background: rgba(139, 92, 246, 0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .admin-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }
        
        .admin-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .admin-tab {
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .admin-tab.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.4) 0%, rgba(124, 58, 237, 0.3) 100%);
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .admin-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .admin-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .admin-item-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        .admin-item-meta {
            font-size: 12px;
            color: #D8B4FE;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .admin-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-approve {
            background: rgba(16, 185, 129, 0.3);
        }
        
        .btn-reject {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .btn-edit {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .btn-block {
            background: rgba(245, 158, 11, 0.3);
        }
        
        .btn-assign {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .admin-btn:hover {
            transform: translateY(-2px);
        }
        
        .admin-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: rgba(124, 58, 237, 0.4);
            border-color: rgba(124, 58, 237, 0.8);
        }
        
        /* Статусы жалоб */
        .complaint-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-new {
            background: rgba(59, 130, 246, 0.3);
            color: #3B82F6;
        }
        
        .status-in-progress {
            background: rgba(245, 158, 11, 0.3);
            color: #F59E0B;
        }
        
        .status-resolved {
            background: rgba(16, 185, 129, 0.3);
            color: #10B981;
        }
        
        .status-rejected {
            background: rgba(239, 68, 68, 0.3);
            color: #EF4444;
        }
        
        /* Аналитика */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .analytics-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .analytics-number {
            font-size: 28px;
            font-weight: 700;
            color: #A78BFA;
            margin-bottom: 5px;
        }
        
        .analytics-label {
            font-size: 12px;
            color: #9CA3AF;
        }
        
        .chart-container {
            height: 200px;
            margin: 20px 0;
            position: relative;
        }
        
        /* Логи */
        .log-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #8B5CF6;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .log-user {
            font-weight: 600;
            color: white;
        }
        
        .log-time {
            font-size: 11px;
            color: #9CA3AF;
        }
        
        .log-action {
            color: #D8B4FE;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .log-reason {
            font-size: 12px;
            color: #9CA3AF;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Шапка -->
        <header class="app-header">
            <div class="logo">
                <i class="fas fa-smoking"></i>
                <span id="header-title">Vape Market</span>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="main-content" id="main-content">
            <!-- ШАГ 1: ЭКРАН БЛОКИРОВКИ (показывается если пользователь заблокирован) -->
            <div id="blocked-screen" style="display: none;">
                <div class="blocked-screen">
                    <div class="blocked-icon">
                        <i class="fas fa-ban"></i>
                    </div>
                    <h1 class="blocked-title">Ваш аккаунт заблокирован</h1>
                    <div class="blocked-reason">
                        <p id="block-reason-text">Нарушение правил сообщества</p>
                        <p id="block-date" style="font-size: 12px; color: #9CA3AF; margin-top: 5px;"></p>
                    </div>
                    <p style="margin: 20px 0; color: #D8B4FE;">
                        Если вы считаете, что блокировка ошибочна, свяжитесь с администратором
                    </p>
                    <button class="contact-admin-btn" onclick="contactAdmin()">
                        <i class="fab fa-telegram"></i>
                        Связаться с @nukm0
                    </button>
                </div>
            </div>

            <!-- Обычное приложение (показывается если пользователь не заблокирован) -->
            <div id="app-content">
                <!-- Страница 1: Объявления -->
                <div class="page active" id="page-ads">
                    <!-- Секция добавления объявления СВЕРХУ -->
                    <div class="add-ad-section">
                        <div class="add-ad-header">
                            <div class="add-ad-title">Разместить объявление</div>
                            <button class="toggle-form-btn" onclick="toggleAddForm()" id="addAdButton">
                                <i class="fas fa-plus-circle"></i>
                                <span id="toggle-btn-text">Добавить</span>
                            </button>
                        </div>
                        
                        <!-- Форма добавления объявления -->
                        <div class="add-ad-form" id="addAdForm">
                            <!-- Скрытый input для загрузки фото -->
                            <input type="file" id="photoInput" class="hidden-file-input" accept="image/*" multiple 
                                   onchange="handlePhotoUpload(event)">
                            
                            <div class="photo-upload-section">
                                <!-- Контейнер для загруженных фото -->
                                <div class="uploaded-photos-container" id="uploaded-photos-container">
                                    <!-- Фото будут добавляться здесь динамически -->
                                </div>
                                
                                <button class="upload-btn" onclick="openPhotoPicker()">
                                    <i class="fas fa-images"></i>
                                    Загрузить фотографии
                                </button>
                                <div class="upload-info">
                                    Можно загрузить до 3 фотографий. Выбрано: <span id="photo-count">0</span>/3
                                </div>
                            </div>

                            <input type="text" class="form-input" placeholder="Название товара" id="adTitle">
                            
                            <select class="form-input" id="adCategory">
                                <option value="">Выберите категорию</option>
                                <option value="liquids">Жидкости</option>
                                <option value="disposable">Одноразовые устройства</option>
                                <option value="pod">Под-системы</option>
                                <option value="consumables">Расходники</option>
                            </select>
                            
                            <input type="number" class="form-input" placeholder="Цена (₽)" id="adPrice">
                            
                            <textarea class="form-input" placeholder="Описание товара" id="adDescription" rows="3"></textarea>
                            
                            <div class="form-buttons">
                                <button class="publish-btn" onclick="publishAd()">
                                    <i class="fas fa-paper-plane"></i>
                                    Опубликовать
                                </button>
                                <button class="cancel-btn" onclick="toggleAddForm()">
                                    <i class="fas fa-times"></i>
                                    Отмена
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Категории -->
                    <div class="categories">
                        <button class="category-btn active" onclick="filterCategory('all')">Все</button>
                        <button class="category-btn" onclick="filterCategory('liquids')">Жидкости</button>
                        <button class="category-btn" onclick="filterCategory('disposable')">Одноразовые</button>
                        <button class="category-btn" onclick="filterCategory('pod')">Под-системы</button>
                        <button class="category-btn" onclick="filterCategory('consumables')">Расходники</button>
                    </div>

                    <!-- Объявления будут добавляться здесь -->
                    <div id="ads-container"></div>
                    
                    <!-- Статус синхронизации -->
                    <div class="sync-status" id="sync-status">
                        <div class="sync-indicator"></div>
                        <span id="sync-text">Синхронизировано с Firebase</span>
                    </div>
                </div>

                <!-- Страница 2: Личный кабинет -->
                <div class="page" id="page-profile">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="profile-info">
                                <h2 id="profileName">Загрузка...</h2>
                                <p id="profileUsername">@username</p>
                                <div class="seller-stat stat-rating">
                                    <i class="fas fa-star"></i>
                                    <span id="myRating">0.0</span>
                                </div>
                            </div>
                        </div>

                        <div class="profile-stats">
                            <div class="profile-stat">
                                <div class="stat-number" id="myAdsCount">0</div>
                                <div class="stat-label">Объявления</div>
                            </div>
                            <div class="profile-stat">
                                <div class="stat-number" id="myLikesCount">0</div>
                                <div class="stat-label">Лайки</div>
                            </div>
                            <div class="profile-stat">
                                <div class="stat-number" id="myDislikesCount">0</div>
                                <div class="stat-label">Дизлайки</div>
                            </div>
                        </div>

                        <!-- Вкладки в личном кабинете -->
                        <div class="profile-tabs">
                            <div class="profile-tab active" onclick="switchProfileTab('my-ads')">
                                Мои объявления
                            </div>
                            <div class="profile-tab" onclick="switchProfileTab('history')">
                                История
                            </div>
                        </div>

                        <!-- Содержимое вкладки "Мои объявления" -->
                        <div class="profile-tab-content active" id="my-ads-tab">
                            <div class="my-ads-list" id="myAdsList">
                                <!-- Мои объявления будут здесь -->
                            </div>
                        </div>

                        <!-- Содержимое вкладки "История" -->
                        <div class="profile-tab-content" id="history-tab">
                            <div class="history-list" id="historyList">
                                <!-- История будет добавляться здесь -->
                            </div>
                            
                            <button class="cancel-btn" onclick="clearHistory()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-trash"></i>
                                Очистить историю
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Страница 3: FAQ -->
                <div class="page" id="page-faq">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar" style="background: var(--gradient-primary);">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="profile-info">
                                <h2>Частые вопросы</h2>
                                <p>Помощь по использованию</p>
                            </div>
                        </div>

                        <div class="faq-list">
                            <div class="faq-item" onclick="toggleFaq(1)">
                                <div class="faq-question">
                                    <span>Как добавить объявление?</span>
                                    <i class="fas fa-chevron-down" id="faq-icon-1"></i>
                                </div>
                                <div class="faq-answer" id="faq-answer-1" style="display: none;">
                                    Нажмите кнопку "Добавить" сверху. Заполните форму и загрузите до 3 фотографий из галереи.
                                </div>
                            </div>
                            
                            <div class="faq-item" onclick="toggleFaq(2)">
                                <div class="faq-question">
                                    <span>Как система рейтинга?</span>
                                    <i class="fas fa-chevron-down" id="faq-icon-2"></i>
                                </div>
                                <div class="faq-answer" id="faq-answer-2" style="display: none;">
                                    Рейтинг рассчитывается по формуле: 0.1 + (лайки / (лайки + дизлайки)) × 4.9. 
                                    Каждый пользователь может поставить только одну оценку.
                                </div>
                            </div>
                            
                            <div class="faq-item" onclick="toggleFaq(3)">
                                <div class="faq-question">
                                    <span>Как загрузить фото?</span>
                                    <i class="fas fa-chevron-down" id="faq-icon-3"></i>
                                </div>
                                <div class="faq-answer" id="faq-answer-3" style="display: none;">
                                    Нажмите на "Загрузить фотографии" → откроется галерея устройства. 
                                    Можно выбрать до 3 фото одновременно.
                                </div>
                            </div>
                            
                            <div class="faq-item" onclick="toggleFaq(4)">
                                <div class="faq-question">
                                    <span>Как написать продавцу?</span>
                                    <i class="fas fa-chevron-down" id="faq-icon-4"></i>
                                </div>
                                <div class="faq-answer" id="faq-answer-4" style="display: none;">
                                    Нажмите кнопку "Написать продавцу". В чат автоматически добавится сообщение 
                                    о товаре и его категории.
                                </div>
                            </div>
                            
                            <div class="faq-item" onclick="toggleFaq(5)">
                                <div class="faq-question">
                                    <span>Статистика сервера</span>
                                    <i class="fas fa-chevron-down" id="faq-icon-5"></i>
                                </div>
                                <div class="faq-answer" id="faq-answer-5" style="display: none;">
                                    Статистика указана в самом низу
                                </div>
                            </div>
                            
                            <div class="faq-item" onclick="toggleFaq(6)">
                                <div class="faq-question">
                                    <span>Как оплачивать товар?</span>
                                    <i class="fas fa-chevron-down" id="faq-icon-6"></i>
                                </div>
                                <div class="faq-answer" id="faq-answer-6" style="display: none;">
                                    Все сделки происходят напрямую с продавцом в Telegram. 
                                    Договаривайтесь об оплате в личном чате.
                                </div>
                            </div>
                        </div>

                        <!-- Статистика сервера -->
                        <div class="server-stats" id="server-stats">
                            <div class="server-stats-header">
                                <i class="fas fa-server"></i>
                                <div class="server-stats-title">Статистика сервера</div>
                                <button class="remove-photo-btn" onclick="refreshStats()" style="position: static; margin-left: auto; background: rgba(124, 58, 237, 0.6);">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="server-stats-grid" id="server-stats-grid">
                                <!-- Статистика будет заполнена динамически -->
                            </div>
                            <div class="sync-status">
                                <div class="sync-indicator"></div>
                                <span id="server-sync-text">Обновлено только что</span>
                            </div>
                        </div>

                        <!-- Кнопка подачи жалобы -->
                        <button class="complaint-btn" onclick="submitComplaint()">
                            <i class="fas fa-exclamation-triangle"></i>
                            Подать жалобу
                        </button>
                    </div>
                </div>

                <!-- ШАГ 2: СТРАНИЦА АДМИН-ПАНЕЛИ (только для админов/модераторов) -->
                <div class="page" id="page-admin">
                    <div class="admin-panel">
                        <div class="admin-header">
                            <div class="admin-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="admin-title">
                                Админ-панель
                                <div style="font-size: 12px; color: #D8B4FE; margin-top: 5px;" id="admin-role">
                                    <!-- Роль будет указана здесь -->
                                </div>
                            </div>
                        </div>

                        <!-- Вкладки админ-панели -->
                        <div class="admin-tabs" id="admin-tabs">
                            <div class="admin-tab active" onclick="switchAdminTab('moderation')">
                                <i class="fas fa-clipboard-check"></i> Модерация
                            </div>
                            <div class="admin-tab" onclick="switchAdminTab('users')">
                                <i class="fas fa-users"></i> Пользователи
                            </div>
                            <div class="admin-tab" onclick="switchAdminTab('complaints')">
                                <i class="fas fa-flag"></i> Жалобы
                                <span id="new-complaints-count" class="complaint-status status-new" style="margin-left: 5px;">0</span>
                            </div>
                            <div class="admin-tab" onclick="switchAdminTab('analytics')">
                                <i class="fas fa-chart-bar"></i> Аналитика
                            </div>
                            <div class="admin-tab" onclick="switchAdminTab('logs')">
                                <i class="fas fa-history"></i> Логи
                            </div>
                        </div>

                        <!-- Вкладка: Модерация объявлений -->
                        <div class="admin-tab-content active" id="moderation-tab">
                            <div class="admin-filter">
                                <button class="filter-btn active" onclick="filterAds('all')">Все</button>
                                <button class="filter-btn" onclick="filterAds('new')">Новые</button>
                                <button class="filter-btn" onclick="filterAds('reported')">С жалобами</button>
                                <button class="filter-btn" onclick="filterAds('pending')">На проверке</button>
                            </div>
                            <div class="admin-list" id="moderation-list">
                                <!-- Список объявлений для модерации -->
                            </div>
                        </div>

                        <!-- Вкладка: Управление пользователями -->
                        <div class="admin-tab-content" id="users-tab">
                            <div class="admin-filter">
                                <button class="filter-btn active" onclick="filterUsers('all')">Все</button>
                                <button class="filter-btn" onclick="filterUsers('active')">Активные</button>
                                <button class="filter-btn" onclick="filterUsers('blocked')">Заблокированные</button>
                                <button class="filter-btn" onclick="filterUsers('sellers')">Продавцы</button>
                            </div>
                            <div class="admin-list" id="users-list">
                                <!-- Список пользователей -->
                            </div>
                        </div>

                        <!-- Вкладка: Жалобы -->
                        <div class="admin-tab-content" id="complaints-tab">
                            <div class="admin-filter">
                                <button class="filter-btn active" onclick="filterComplaints('all')">Все</button>
                                <button class="filter-btn" onclick="filterComplaints('new')">
                                    Новые <span class="complaint-status status-new" id="new-complaints-badge">0</span>
                                </button>
                                <button class="filter-btn" onclick="filterComplaints('in-progress')">В работе</button>
                                <button class="filter-btn" onclick="filterComplaints('resolved')">Решённые</button>
                            </div>
                            <div class="admin-list" id="complaints-list">
                                <!-- Список жалоб -->
                            </div>
                        </div>

                        <!-- Вкладка: Аналитика -->
                        <div class="admin-tab-content" id="analytics-tab">
                            <div class="analytics-grid">
                                <div class="analytics-card">
                                    <div class="analytics-number" id="total-users">0</div>
                                    <div class="analytics-label">Пользователей</div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-number" id="total-ads">0</div>
                                    <div class="analytics-label">Объявлений</div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-number" id="total-complaints">0</div>
                                    <div class="analytics-label">Жалоб</div>
                                </div>
                                <div class="analytics-card">
                                    <div class="analytics-number" id="blocked-users">0</div>
                                    <div class="analytics-label">Блокировок</div>
                                </div>
                            </div>
                            <div style="margin: 20px 0;">
                                <h3 style="font-size: 16px; margin-bottom: 10px;">Активность за неделю</h3>
                                <div class="chart-container" id="activity-chart">
                                    <!-- График активности -->
                                </div>
                            </div>
                            <div>
                                <h3 style="font-size: 16px; margin-bottom: 10px;">Топ нарушителей</h3>
                                <div id="top-violators">
                                    <!-- Список нарушителей -->
                                </div>
                            </div>
                        </div>

                        <!-- Вкладка: Логи действий -->
                        <div class="admin-tab-content" id="logs-tab">
                            <div class="admin-filter">
                                <button class="filter-btn active" onclick="filterLogs('all')">Все</button>
                                <button class="filter-btn" onclick="filterLogs('block')">Блокировки</button>
                                <button class="filter-btn" onclick="filterLogs('delete')">Удаления</button>
                                <button class="filter-btn" onclick="filterLogs('complaint')">Жалобы</button>
                            </div>
                            <div class="admin-list" id="admin-logs">
                                <!-- Логи действий -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ШАГ 2: Нижнее меню навигации с иконкой админа -->
        <nav class="bottom-nav" id="bottom-nav">
            <button class="nav-item active" data-page="ads" onclick="switchPage('ads')">
                <div class="nav-icon">
                    <i class="fas fa-box-open"></i>
                </div>
                <span class="nav-label">Объявления</span>
            </button>
            
            <!-- Иконка админа (показывается только если rights > 0) -->
            <button class="nav-item" data-page="admin" onclick="switchPage('admin')" id="admin-nav-item" style="display: none;">
                <div class="nav-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <span class="nav-label">Админ</span>
            </button>
            
            <button class="nav-item" data-page="profile" onclick="switchPage('profile')">
                <div class="nav-icon">
                    <i class="fas fa-user-circle"></i>
                </div>
                <span class="nav-label">Кабинет</span>
            </button>
            
            <button class="nav-item" data-page="faq" onclick="switchPage('faq')">
                <div class="nav-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <span class="nav-label">FAQ</span>
            </button>
        </nav>

        <!-- Модальное окно для просмотра фото -->
        <div class="photo-modal" id="photoModal">
            <button class="photo-modal-close" onclick="closePhotoModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="photo-modal-nav">
                <button class="photo-modal-nav-btn" onclick="prevPhoto()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="photo-modal-nav-btn" onclick="nextPhoto()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <img class="photo-modal-img" id="modalPhoto" src="" alt="Просмотр фото">
            <div class="photo-modal-counter" id="photoCounter">1 / 1</div>
        </div>

        <!-- Модальное окно для подачи жалобы -->
        <div class="complaint-modal" id="complaintModal">
            <div class="complaint-modal-content">
                <div class="complaint-modal-header">
                    <div class="complaint-modal-title">Подать жалобу</div>
                    <button class="complaint-close-btn" onclick="closeComplaintModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Тип жалобы:</label>
                    <select class="complaint-select" id="complaintType">
                        <option value="scam">Мошенничество</option>
                        <option value="spam">Спам</option>
                        <option value="offensive">Оскорбления</option>
                        <option value="inappropriate">Неуместный контент</option>
                        <option value="fake">Фейковое объявление</option>
                        <option value="other">Другое</option>
                    </select>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Приоритет:</label>
                    <div class="complaint-priority">
                        <button class="priority-btn priority-low" onclick="setComplaintPriority('low')">Низкий</button>
                        <button class="priority-btn priority-medium active" onclick="setComplaintPriority('medium')">Средний</button>
                        <button class="priority-btn priority-high" onclick="setComplaintPriority('high')">Высокий</button>
                    </div>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Описание проблемы:</label>
                    <textarea class="complaint-textarea" id="complaintDescription" 
                              placeholder="Опишите подробно проблему..."></textarea>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Скриншот (если есть):</label>
                    <div class="complaint-screenshot">
                        <button class="screenshot-btn" onclick="attachScreenshot()">
                            <i class="fas fa-camera"></i>
                            Прикрепить скриншот
                        </button>
                        <span id="screenshot-name" style="color: #D8B4FE; font-size: 12px;"></span>
                    </div>
                    <input type="file" id="screenshotInput" class="hidden-file-input" accept="image/*" 
                           onchange="handleScreenshotUpload(event)">
                </div>
                
                <button class="complaint-submit-btn" onclick="submitComplaintForm()">
                    <i class="fas fa-paper-plane"></i>
                    Отправить жалобу
                </button>
            </div>
        </div>

        <!-- Модальное окно блокировки пользователя -->
        <div class="complaint-modal" id="blockUserModal">
            <div class="complaint-modal-content">
                <div class="complaint-modal-header">
                    <div class="complaint-modal-title">Блокировка пользователя</div>
                    <button class="complaint-close-btn" onclick="closeBlockModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Пользователь:</label>
                    <div id="block-user-info" style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 15px;">
                        <!-- Информация о пользователе -->
                    </div>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Причина блокировки:</label>
                    <select class="complaint-select" id="blockReason">
                        <option value="scam">Мошенничество</option>
                        <option value="spam">Спам/флуд</option>
                        <option value="offensive">Оскорбления</option>
                        <option value="multiple_complaints">Множественные жалобы</option>
                        <option value="fake_ads">Фейковые объявления</option>
                        <option value="other">Другая причина</option>
                    </select>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Подробное описание:</label>
                    <textarea class="complaint-textarea" id="blockDetails" 
                              placeholder="Опишите подробно причину блокировки..."></textarea>
                </div>
                
                <div class="complaint-form-group">
                    <label class="complaint-label">Срок блокировки:</label>
                    <select class="complaint-select" id="blockDuration">
                        <option value="1">1 день</option>
                        <option value="7">7 дней</option>
                        <option value="30">30 дней</option>
                        <option value="permanent">Навсегда</option>
                    </select>
                </div>
                
                <div class="form-buttons">
                    <button class="complaint-submit-btn" onclick="confirmBlockUser()" style="flex: 2;">
                        <i class="fas fa-ban"></i>
                        Заблокировать
                    </button>
                    <button class="cancel-btn" onclick="closeBlockModal()" style="flex: 1;">
                        Отмена
                    </button>
                </div>
            </div>
        </div>

        <!-- Уведомление -->
        <div class="notification" id="notification"></div>
    </div>

    <script>
        // ==================== FIREBASE КОНФИГУРАЦИЯ ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBgPG4EXFQHoIOVLt2_BdCmiUJEWTXsGN8",
            authDomain: "telegram-market-vape.firebaseapp.com",
            databaseURL: "https://telegram-market-vape-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "telegram-market-vape",
            storageBucket: "telegram-market-vape.appspot.com",
            messagingSenderId: "35870048384",
            appId: "1:35870048384:web:acd6501459aa39180b6665",
            measurementId: "G-99R2PPBNF8"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // ==================== КОНЕЦ FIREBASE ====================

        // ==================== ОСНОВНОЙ КОД ПРИЛОЖЕНИЯ (Ваш существующий код) ====================
        
        // Ваш существующий код FirebaseMarketServer остается БЕЗ ИЗМЕНЕНИЙ
        const FirebaseMarketServer = {
            // ... [Ваш существующий код FirebaseMarketServer без изменений] ...
            // Добавить объявление
            addAd: async function(adData) {
                try {
                    console.log('🔄 Добавляю объявление в Firebase...');
                    
                    // Регистрируем пользователя
                    await this.registerUser({
                        id: adData.sellerId,
                        name: adData.sellerName,
                        username: adData.sellerUsername
                    });
                    
                    // Подготавливаем данные
                    const adToSave = {
                        sellerId: adData.sellerId,
                        sellerName: adData.sellerName,
                        sellerUsername: adData.sellerUsername,
                        sellerAvatar: adData.sellerAvatar || null,
                        title: adData.title,
                        category: adData.category,
                        price: Number(adData.price),
                        description: adData.description || '',
                        photoUrls: adData.photoUrls || [],
                        photos: adData.photoUrls?.length || 0,
                        likes: 0,
                        dislikes: 0,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Добавляем в базу
                    const newAdRef = database.ref('ads').push();
                    const adId = newAdRef.key;
                    
                    await newAdRef.set(adToSave);
                    
                    // Обновляем счетчик пользователя
                    await database.ref(`users/${adData.sellerId}/adsCount`).transaction((current) => {
                        return (current || 0) + 1;
                    });
                    
                    console.log('✅ Объявление добавлено, ID:', adId);
                    return adId;
                    
                } catch (error) {
                    console.error('❌ Ошибка добавления:', error);
                    throw error;
                }
            },
            
            // Получить все объявления
            getAllAds: async function() {
                try {
                    const snapshot = await database.ref('ads').once('value');
                    const ads = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const ad = childSnapshot.val();
                        ad.id = childSnapshot.key;
                        ads.push(ad);
                    });
                    
                    // Сортируем по дате (новые сначала)
                    ads.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    
                    return ads;
                } catch (error) {
                    console.error('❌ Ошибка загрузки объявлений:', error);
                    return [];
                }
            },
            
            // Слушать новые объявления в реальном времени
            listenToAds: function(callback) {
                database.ref('ads').on('value', (snapshot) => {
                    const ads = [];
                    snapshot.forEach((childSnapshot) => {
                        const ad = childSnapshot.val();
                        ad.id = childSnapshot.key;
                        ads.push(ad);
                    });
                    
                    // Сортируем
                    ads.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    callback(ads);
                });
            },
            
            // Получить рейтинги
            getRatings: async function() {
                try {
                    const snapshot = await database.ref('ratings').once('value');
                    return snapshot.val() || {};
                } catch (error) {
                    console.error('❌ Ошибка загрузки рейтингов:', error);
                    return {};
                }
            },
            
            // Обновить рейтинг
            updateRating: async function(sellerId, userId, rating) {
                try {
                    // Сохраняем оценку
                    await database.ref(`ratings/${sellerId}/${userId}`).set(rating);
                    
                    // Получаем все оценки
                    const ratingsSnapshot = await database.ref(`ratings/${sellerId}`).once('value');
                    const ratings = ratingsSnapshot.val() || {};
                    
                    // Считаем лайки/дизлайки
                    let likes = 0, dislikes = 0;
                    Object.values(ratings).forEach(r => {
                        if (r === 'like') likes++;
                        if (r === 'dislike') dislikes++;
                    });
                    
                    // Рассчитываем рейтинг
                    const total = likes + dislikes;
                    const calculatedRating = total > 0 ? 0.1 + (likes / total) * 4.9 : 0.1;
                    
                    // Обновляем пользователя
                    await database.ref(`users/${sellerId}`).update({
                        likesCount: likes,
                        dislikesCount: dislikes,
                        rating: calculatedRating,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    return true;
                } catch (error) {
                    console.error('❌ Ошибка обновления рейтинга:', error);
                    return false;
                }
            },
            
            // Регистрация пользователя
            registerUser: async function(userData) {
                try {
                    const userRef = database.ref(`users/${userData.id}`);
                    const snapshot = await userRef.once('value');
                    
                    if (!snapshot.exists()) {
                        await userRef.set({
                            id: userData.id,
                            name: userData.name || 'Пользователь',
                            username: userData.username || '',
                            registrationDate: firebase.database.ServerValue.TIMESTAMP,
                            lastActive: firebase.database.ServerValue.TIMESTAMP,
                            adsCount: 0,
                            likesCount: 0,
                            dislikesCount: 0,
                            rating: 0.1
                        });
                        console.log('✅ Новый пользователь зарегистрирован');
                    } else {
                        await userRef.update({
                            lastActive: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                    
                    return true;
                } catch (error) {
                    console.error('❌ Ошибка регистрации:', error);
                    return false;
                }
            },
            
            // Добавить в историю
            addToHistory: async function(userId, historyItem) {
                try {
                    const historyRef = database.ref(`userHistory/${userId}`).push();
                    await historyRef.set({
                        ...historyItem,
                        id: historyRef.key,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Ограничиваем историю 50 записями
                    const historySnapshot = await database.ref(`userHistory/${userId}`).once('value');
                    const history = [];
                    historySnapshot.forEach((child) => {
                        history.push({ key: child.key, ...child.val() });
                    });
                    
                    if (history.length > 50) {
                        const toDelete = history.slice(50);
                        for (const item of toDelete) {
                            await database.ref(`userHistory/${userId}/${item.key}`).remove();
                        }
                    }
                    
                    return true;
                } catch (error) {
                    console.error('❌ Ошибка сохранения истории:', error);
                    return false;
                }
            },
            
            // Получить историю пользователя
            getUserHistory: async function(userId) {
                try {
                    const snapshot = await database.ref(`userHistory/${userId}`).once('value');
                    const history = [];
                    snapshot.forEach((childSnapshot) => {
                        history.unshift(childSnapshot.val());
                    });
                    return history;
                } catch (error) {
                    console.error('❌ Ошибка загрузки истории:', error);
                    return [];
                }
            },
            
            // Удалить объявление
            deleteAd: async function(adId, sellerId) {
                try {
                    await database.ref(`ads/${adId}`).remove();
                    
                    // Уменьшаем счетчик объявлений пользователя
                    await database.ref(`users/${sellerId}/adsCount`).transaction((current) => {
                        return Math.max(0, (current || 1) - 1);
                    });
                    
                    return true;
                } catch (error) {
                    console.error('❌ Ошибка удаления объявления:', error);
                    return false;
                }
            },
            
            // Обновить объявление
            updateAd: async function(adId, adData) {
                try {
                    await database.ref(`ads/${adId}`).update(adData);
                    return true;
                } catch (error) {
                    console.error('❌ Ошибка обновления объявления:', error);
                    return false;
                }
            },
            
            // Получить статистику
            getStats: async function() {
                try {
                    // Получаем количество объявлений
                    const adsSnapshot = await database.ref('ads').once('value');
                    const totalAds = adsSnapshot.numChildren();
                    
                    // Получаем количество пользователей
                    const usersSnapshot = await database.ref('users').once('value');
                    const totalUsers = usersSnapshot.numChildren();
                    
                    // Считаем сегодняшние объявления
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    let todayAds = 0;
                    
                    adsSnapshot.forEach((childSnapshot) => {
                        const ad = childSnapshot.val();
                        if (ad.createdAt && new Date(ad.createdAt) >= today) {
                            todayAds++;
                        }
                    });
                    
                    // Считаем лайки и дизлайки
                    const ratingsSnapshot = await database.ref('ratings').once('value');
                    let totalLikes = 0;
                    let totalDislikes = 0;
                    
                    ratingsSnapshot.forEach((userSnapshot) => {
                        userSnapshot.forEach((ratingSnapshot) => {
                            if (ratingSnapshot.val() === 'like') totalLikes++;
                            if (ratingSnapshot.val() === 'dislike') totalDislikes++;
                        });
                    });
                    
                    // Считаем по категориям
                    const categories = { liquids: 0, disposable: 0, pod: 0, consumables: 0, other: 0 };
                    adsSnapshot.forEach((childSnapshot) => {
                        const ad = childSnapshot.val();
                        const category = ad.category || 'other';
                        if (categories[category] !== undefined) {
                            categories[category]++;
                        } else {
                            categories.other++;
                        }
                    });
                    
                    // Считаем активных пользователей (последние 7 дней)
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    let activeUsers = 0;
                    
                    usersSnapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        if (user.lastActive && new Date(user.lastActive) > weekAgo) {
                            activeUsers++;
                        }
                    });
                    
                    return {
                        totalUsers: totalUsers,
                        activeUsers: activeUsers,
                        totalAds: totalAds,
                        todayAds: todayAds,
                        totalLikes: totalLikes,
                        totalDislikes: totalDislikes,
                        categories: categories,
                        lastUpdated: new Date().toISOString(),
                        serverStatus: 'online'
                    };
                    
                } catch (error) {
                    console.error('❌ Ошибка получения статистики:', error);
                    return {
                        totalUsers: 0,
                        activeUsers: 0,
                        totalAds: 0,
                        todayAds: 0,
                        totalLikes: 0,
                        totalDislikes: 0,
                        categories: { liquids: 0, disposable: 0, pod: 0, consumables: 0, other: 0 },
                        lastUpdated: new Date().toISOString(),
                        serverStatus: 'offline'
                    };
                }
            },
            
            // Очистить историю пользователя
            clearUserHistory: async function(userId) {
                try {
                    await database.ref(`userHistory/${userId}`).remove();
                    return true;
                } catch (error) {
                    console.error('❌ Ошибка очистки истории:', error);
                    return false;
                }
            }
        };
        
        // ==================== НОВАЯ СИСТЕМА: ПРАВА, БЛОКИРОВКИ И АДМИН-ПАНЕЛЬ ====================
        
        // Инициализация Telegram Web App
        const tg = window.Telegram?.WebApp;
        
        // Расширенная система данных приложения
        const appData = {
            currentUserId: null,
            currentUserData: null,
            userRights: 0, // 0 = обычный пользователь, 1 = модератор, 2 = админ, 3 = супер-админ
            isBlocked: false,
            blockReason: '',
            blockDate: null,
            ads: [],
            userRatings: {},
            history: [],
            uploadedPhotos: [],
            currentPhotoIndex: 0,
            currentPhotoList: [],
            currentCategory: 'all',
            editingAdId: null,
            serverStats: null,
            lastSyncTime: null,
            isDataLoaded: false,
            currentComplaintTarget: null, // Для жалобы на продавца
            currentComplaintType: null,
            currentComplaintPriority: 'medium',
            complaints: [],
            adminUsers: [],
            adminLogs: []
        };
        
        // ==================== ШАГ 1: ПРОВЕРКА ПРАВ И БЛОКИРОВКИ ====================
        async function checkUserStatus() {
            console.log('🔍 Проверка прав и блокировки пользователя...');
            
            if (!appData.currentUserId) {
                console.error('❌ Нет ID пользователя');
                return;
            }
            
            try {
                // Проверяем блокировку пользователя
                const blockSnapshot = await database.ref(`blockedUsers/${appData.currentUserId}`).once('value');
                
                if (blockSnapshot.exists()) {
                    // Пользователь заблокирован
                    const blockData = blockSnapshot.val();
                    appData.isBlocked = true;
                    appData.blockReason = blockData.reason || 'Нарушение правил сообщества';
                    appData.blockDate = blockData.timestamp || new Date().toISOString();
                    
                    // Показываем экран блокировки
                    showBlockedScreen();
                    return;
                }
                
                // Проверяем права пользователя
                const userSnapshot = await database.ref(`users/${appData.currentUserId}`).once('value');
                
                if (userSnapshot.exists()) {
                    const userData = userSnapshot.val();
                    appData.userRights = userData.rights || 0;
                    
                    // Показываем иконку админа в меню если есть права
                    if (appData.userRights > 0) {
                        document.getElementById('admin-nav-item').style.display = 'flex';
                    }
                    
                    // Обновляем роль в админ-панели
                    updateAdminRole();
                }
                
                // Если не заблокирован, загружаем обычное приложение
                showAppContent();
                
            } catch (error) {
                console.error('❌ Ошибка проверки статуса:', error);
                // В случае ошибки все равно показываем приложение
                showAppContent();
            }
        }
        
        // Показать экран блокировки
        function showBlockedScreen() {
            document.getElementById('blocked-screen').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('bottom-nav').style.display = 'none';
            
            document.getElementById('block-reason-text').textContent = appData.blockReason;
            
            if (appData.blockDate) {
                const date = new Date(appData.blockDate);
                document.getElementById('block-date').textContent = 
                    `Дата блокировки: ${date.toLocaleDateString('ru-RU')}`;
            }
        }
        
        // Показать обычное приложение
        function showAppContent() {
            document.getElementById('blocked-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('bottom-nav').style.display = 'flex';
        }
        
        // Связаться с админом
        function contactAdmin() {
            const message = encodeURIComponent(`Разблокировка аккаунта Vape Market\nID: ${appData.currentUserId}\nПричина блокировки: ${appData.blockReason}`);
            const telegramUrl = `https://t.me/nukm0?text=${message}`;
            
            if (tg) {
                try {
                    tg.openTelegramLink(telegramUrl);
                } catch (error) {
                    tg.showAlert(`Для связи с администратором напишите @nukm0 в Telegram`);
                }
            } else {
                alert('Для связи с администратором напишите @nukm0 в Telegram');
            }
        }
        
        // ==================== ШАГ 3: СИСТЕМА ЖАЛОБ ====================
        
        // Открыть окно подачи жалобы
        function openComplaintModal(sellerId, sellerName, adId = null) {
            appData.currentComplaintTarget = {
                sellerId: sellerId,
                sellerName: sellerName,
                adId: adId
            };
            
            // Сброс формы
            document.getElementById('complaintType').value = 'scam';
            document.getElementById('complaintDescription').value = '';
            document.getElementById('screenshot-name').textContent = '';
            appData.currentComplaintPriority = 'medium';
            
            // Установка активного приоритета
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.priority-medium').classList.add('active');
            
            // Показать модальное окно
            document.getElementById('complaintModal').classList.add('active');
        }
        
        // Закрыть окно жалобы
        function closeComplaintModal() {
            document.getElementById('complaintModal').classList.remove('active');
            appData.currentComplaintTarget = null;
        }
        
        // Установить приоритет жалобы
        function setComplaintPriority(priority) {
            appData.currentComplaintPriority = priority;
            
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelector(`.priority-${priority}`).classList.add('active');
        }
        
        // Прикрепить скриншот
        function attachScreenshot() {
            document.getElementById('screenshotInput').click();
        }
        
        // Обработка загрузки скриншота
        function handleScreenshotUpload(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('screenshot-name').textContent = file.name;
                // Здесь можно сохранить файл, но для простоты просто запоминаем имя
            }
        }
        
        // Отправить жалобу
        async function submitComplaintForm() {
            if (!appData.currentComplaintTarget) {
                showNotification('Ошибка: нет цели жалобы', 'error');
                return;
            }
            
            const complaintType = document.getElementById('complaintType').value;
            const description = document.getElementById('complaintDescription').value.trim();
            
            if (!description) {
                showNotification('Введите описание проблемы', 'error');
                return;
            }
            
            try {
                // Создаем жалобу
                const complaintRef = database.ref('complaints').push();
                const complaintId = complaintRef.key;
                
                const complaintData = {
                    id: complaintId,
                    reporterId: appData.currentUserId,
                    reporterName: appData.currentUserData?.first_name || 'Пользователь',
                    targetId: appData.currentComplaintTarget.sellerId,
                    targetName: appData.currentComplaintTarget.sellerName,
                    adId: appData.currentComplaintTarget.adId,
                    type: complaintType,
                    priority: appData.currentComplaintPriority,
                    description: description,
                    status: 'new',
                    screenshot: document.getElementById('screenshot-name').textContent || null,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                await complaintRef.set(complaintData);
                
                // Создаем лог
                await createAdminLog(
                    'complaint',
                    `Подана жалоба на пользователя ${appData.currentComplaintTarget.sellerName}`,
                    appData.currentUserId
                );
                
                // Уведомляем админов (можно добавить отправку уведомлений)
                notifyAdmins('Новая жалоба', `Получена новая жалоба от пользователя ${appData.currentUserData?.first_name}`);
                
                showNotification('Жалоба успешно отправлена', 'success');
                closeComplaintModal();
                
                // Обновляем счетчик жалоб в админ-панели
                updateComplaintsCount();
                
            } catch (error) {
                console.error('❌ Ошибка отправки жалобы:', error);
                showNotification('Ошибка при отправке жалобы', 'error');
            }
        }
        
        // Обновить счетчик жалоб
        async function updateComplaintsCount() {
            try {
                const snapshot = await database.ref('complaints').orderByChild('status').equalTo('new').once('value');
                const count = snapshot.numChildren();
                
                document.getElementById('new-complaints-count').textContent = count;
                document.getElementById('new-complaints-badge').textContent = count;
                
            } catch (error) {
                console.error('Ошибка обновления счетчика жалоб:', error);
            }
        }
        
        // ==================== ШАГ 4: АДМИН-ПАНЕЛЬ ====================
        
        // Переключение вкладок админ-панели
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchAdminTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            // Загружаем данные для вкладки
            switch(tab) {
                case 'moderation':
                    loadAdsForModeration();
                    break;
                case 'users':
                    loadUsersForAdmin();
                    break;
                case 'complaints':
                    loadComplaintsForAdmin();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'logs':
                    loadAdminLogs();
                    break;
            }
        }
        
        // Обновить роль админа
        function updateAdminRole() {
            const roles = {
                0: 'Пользователь',
                1: 'Модератор',
                2: 'Администратор',
                3: 'Супер-администратор'
            };
            
            const roleElement = document.getElementById('admin-role');
            if (roleElement) {
                roleElement.textContent = `Роль: ${roles[appData.userRights] || 'Пользователь'}`;
            }
        }
        
        // Загрузка объявлений для модерации
        async function loadAdsForModeration(filter = 'all') {
            try {
                const adsRef = database.ref('ads');
                const snapshot = await adsRef.once('value');
                const ads = [];
                
                snapshot.forEach((childSnapshot) => {
                    const ad = childSnapshot.val();
                    ad.id = childSnapshot.key;
                    ads.push(ad);
                });
                
                // Применяем фильтр
                let filteredAds = ads;
                if (filter === 'new') {
                    // Объявления за последние 24 часа
                    const dayAgo = new Date();
                    dayAgo.setDate(dayAgo.getDate() - 1);
                    filteredAds = ads.filter(ad => new Date(ad.createdAt) > dayAgo);
                } else if (filter === 'reported') {
                    // TODO: Объявления с жалобами
                    filteredAds = ads;
                }
                
                const container = document.getElementById('moderation-list');
                container.innerHTML = '';
                
                if (filteredAds.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px; color: #D8B4FE;">Нет объявлений для модерации</div>';
                    return;
                }
                
                filteredAds.forEach(ad => {
                    const adElement = document.createElement('div');
                    adElement.className = 'admin-item';
                    
                    const date = new Date(ad.createdAt).toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    adElement.innerHTML = `
                        <div class="admin-item-header">
                            <div class="admin-item-title">${ad.title}</div>
                            <div class="admin-item-meta">${date}</div>
                        </div>
                        <div class="admin-item-meta">
                            Продавец: ${ad.sellerName} • Категория: ${getCategoryName(ad.category)} • Цена: ${ad.price.toLocaleString()} ₽
                        </div>
                        <div class="admin-actions">
                            <button class="admin-btn btn-approve" onclick="approveAd('${ad.id}')">
                                <i class="fas fa-check"></i> Одобрить
                            </button>
                            <button class="admin-btn btn-edit" onclick="editAdAsAdmin('${ad.id}')">
                                <i class="fas fa-edit"></i> Редактировать
                            </button>
                            <button class="admin-btn btn-delete" onclick="deleteAdAsAdmin('${ad.id}', '${ad.sellerId}')">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                            <button class="admin-btn btn-block" onclick="blockUserFromAd('${ad.sellerId}', '${ad.sellerName}')">
                                <i class="fas fa-ban"></i> Блокировать
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(adElement);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки объявлений для модерации:', error);
            }
        }
        
        // Фильтрация объявлений в админ-панели
        function filterAds(filter) {
            document.querySelectorAll('#moderation-tab .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadAdsForModeration(filter);
        }
        
        // Одобрить объявление
        async function approveAd(adId) {
            try {
                await database.ref(`ads/${adId}/status`).set('approved');
                await createAdminLog('approve_ad', `Одобрено объявление ${adId}`, appData.currentUserId);
                showNotification('Объявление одобрено', 'success');
                loadAdsForModeration();
            } catch (error) {
                showNotification('Ошибка при одобрении', 'error');
            }
        }
        
        // Удалить объявление как админ
        async function deleteAdAsAdmin(adId, sellerId) {
            if (!confirm('Вы уверены, что хотите удалить это объявление?')) return;
            
            try {
                await FirebaseMarketServer.deleteAd(adId, sellerId);
                await createAdminLog('delete_ad', `Удалено объявление ${adId}`, appData.currentUserId);
                showNotification('Объявление удалено', 'success');
                loadAdsForModeration();
            } catch (error) {
                showNotification('Ошибка при удалении', 'error');
            }
        }
        
        // Загрузка пользователей для админ-панели
        async function loadUsersForAdmin(filter = 'all') {
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                const users = [];
                
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    user.id = childSnapshot.key;
                    users.push(user);
                });
                
                // Проверяем блокировки
                const blockedSnapshot = await database.ref('blockedUsers').once('value');
                const blockedUsers = blockedSnapshot.val() || {};
                
                // Применяем фильтр
                let filteredUsers = users;
                if (filter === 'blocked') {
                    filteredUsers = users.filter(user => blockedUsers[user.id]);
                } else if (filter === 'active') {
                    filteredUsers = users.filter(user => !blockedUsers[user.id]);
                } else if (filter === 'sellers') {
                    filteredUsers = users.filter(user => (user.adsCount || 0) > 0);
                }
                
                const container = document.getElementById('users-list');
                container.innerHTML = '';
                
                filteredUsers.forEach(user => {
                    const isBlocked = blockedUsers[user.id];
                    const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleDateString('ru-RU') : 'Неизвестно';
                    
                    const userElement = document.createElement('div');
                    userElement.className = 'admin-item';
                    
                    userElement.innerHTML = `
                        <div class="admin-item-header">
                            <div class="admin-item-title">
                                ${user.name || 'Пользователь'}
                                ${isBlocked ? '<span class="complaint-status status-rejected" style="margin-left: 10px;">Заблокирован</span>' : ''}
                            </div>
                            <div class="admin-item-meta">ID: ${user.id}</div>
                        </div>
                        <div class="admin-item-meta">
                            @${user.username || 'нет username'} • Объявлений: ${user.adsCount || 0} • Рейтинг: ${(user.rating || 0.1).toFixed(1)}<br>
                            Последняя активность: ${lastActive}
                        </div>
                        <div class="admin-actions">
                            ${isBlocked ? 
                                `<button class="admin-btn btn-approve" onclick="unblockUser('${user.id}', '${user.name}')">
                                    <i class="fas fa-unlock"></i> Разблокировать
                                </button>` :
                                `<button class="admin-btn btn-block" onclick="openBlockModal('${user.id}', '${user.name || 'Пользователь'}')">
                                    <i class="fas fa-ban"></i> Блокировать
                                </button>`
                            }
                            <button class="admin-btn btn-edit" onclick="editUserRights('${user.id}', '${user.name}')">
                                <i class="fas fa-user-cog"></i> Права
                            </button>
                            <button class="admin-btn" onclick="viewUserActivity('${user.id}')">
                                <i class="fas fa-history"></i> Активность
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(userElement);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
        }
        
        // Фильтрация пользователей
        function filterUsers(filter) {
            document.querySelectorAll('#users-tab .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadUsersForAdmin(filter);
        }
        
        // Открыть модальное окно блокировки
        function openBlockModal(userId, userName) {
            appData.currentBlockTarget = { userId, userName };
            
            document.getElementById('block-user-info').innerHTML = `
                <strong>${userName}</strong><br>
                ID: ${userId}
            `;
            
            document.getElementById('blockUserModal').classList.add('active');
        }
        
        // Закрыть модальное окно блокировки
        function closeBlockModal() {
            document.getElementById('blockUserModal').classList.remove('active');
            appData.currentBlockTarget = null;
        }
        
        // Подтвердить блокировку пользователя
        async function confirmBlockUser() {
            if (!appData.currentBlockTarget) return;
            
            const reason = document.getElementById('blockReason').value;
            const details = document.getElementById('blockDetails').value.trim();
            const duration = document.getElementById('blockDuration').value;
            
            if (!details) {
                showNotification('Введите описание причины блокировки', 'error');
                return;
            }
            
            try {
                const blockData = {
                    userId: appData.currentBlockTarget.userId,
                    userName: appData.currentBlockTarget.userName,
                    reason: reason,
                    details: details,
                    duration: duration,
                    blockedBy: appData.currentUserId,
                    blockedByName: appData.currentUserData?.first_name || 'Администратор',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`blockedUsers/${appData.currentBlockTarget.userId}`).set(blockData);
                
                // Создаем лог
                await createAdminLog(
                    'block_user',
                    `Заблокирован пользователь ${appData.currentBlockTarget.userName}`,
                    appData.currentUserId,
                    details
                );
                
                showNotification('Пользователь заблокирован', 'success');
                closeBlockModal();
                loadUsersForAdmin();
                
            } catch (error) {
                console.error('Ошибка блокировки пользователя:', error);
                showNotification('Ошибка при блокировке', 'error');
            }
        }
        
        // Разблокировать пользователя
        async function unblockUser(userId, userName) {
            if (!confirm(`Разблокировать пользователя ${userName}?`)) return;
            
            try {
                await database.ref(`blockedUsers/${userId}`).remove();
                
                await createAdminLog(
                    'unblock_user',
                    `Разблокирован пользователь ${userName}`,
                    appData.currentUserId
                );
                
                showNotification('Пользователь разблокирован', 'success');
                loadUsersForAdmin();
                
            } catch (error) {
                showNotification('Ошибка при разблокировке', 'error');
            }
        }
        
        // Загрузка жалоб для админ-панели
        async function loadComplaintsForAdmin(filter = 'all') {
            try {
                const complaintsRef = database.ref('complaints');
                const snapshot = await complaintsRef.once('value');
                const complaints = [];
                
                snapshot.forEach((childSnapshot) => {
                    const complaint = childSnapshot.val();
                    complaint.id = childSnapshot.key;
                    complaints.push(complaint);
                });
                
                // Применяем фильтр
                let filteredComplaints = complaints;
                if (filter === 'new') {
                    filteredComplaints = complaints.filter(c => c.status === 'new');
                } else if (filter === 'in-progress') {
                    filteredComplaints = complaints.filter(c => c.status === 'in-progress');
                } else if (filter === 'resolved') {
                    filteredComplaints = complaints.filter(c => c.status === 'resolved');
                }
                
                // Сортируем по дате (новые сначала)
                filteredComplaints.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                const container = document.getElementById('complaints-list');
                container.innerHTML = '';
                
                if (filteredComplaints.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px; color: #D8B4FE;">Нет жалоб</div>';
                    return;
                }
                
                filteredComplaints.forEach(complaint => {
                    const date = new Date(complaint.createdAt).toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const statusClass = `status-${complaint.status.replace('-', '')}`;
                    const statusText = getComplaintStatusText(complaint.status);
                    
                    const complaintElement = document.createElement('div');
                    complaintElement.className = 'admin-item';
                    
                    complaintElement.innerHTML = `
                        <div class="admin-item-header">
                            <div class="admin-item-title">
                                Жалоба на ${complaint.targetName}
                                <span class="complaint-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="admin-item-meta">${date}</div>
                        </div>
                        <div class="admin-item-meta">
                            Тип: ${getComplaintTypeText(complaint.type)} • Приоритет: ${complaint.priority === 'high' ? 'Высокий' : complaint.priority === 'medium' ? 'Средний' : 'Низкий'}<br>
                            От: ${complaint.reporterName}
                        </div>
                        <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            ${complaint.description}
                        </div>
                        <div class="admin-actions">
                            ${complaint.status === 'new' ? `
                                <button class="admin-btn btn-assign" onclick="assignComplaint('${complaint.id}')">
                                    <i class="fas fa-user-check"></i> Взять в работу
                                </button>
                            ` : ''}
                            
                            ${complaint.status === 'in-progress' && complaint.assignedTo === appData.currentUserId ? `
                                <button class="admin-btn btn-approve" onclick="resolveComplaint('${complaint.id}')">
                                    <i class="fas fa-check"></i> Решено
                                </button>
                                <button class="admin-btn btn-reject" onclick="rejectComplaint('${complaint.id}')">
                                    <i class="fas fa-times"></i> Отклонить
                                </button>
                            ` : ''}
                            
                            <button class="admin-btn btn-block" onclick="blockUserFromComplaint('${complaint.targetId}', '${complaint.targetName}')">
                                <i class="fas fa-ban"></i> Блокировать
                            </button>
                            
                            <button class="admin-btn" onclick="requestMoreInfo('${complaint.id}', '${complaint.reporterId}')">
                                <i class="fas fa-info-circle"></i> Запросить инфо
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(complaintElement);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки жалоб:', error);
            }
        }
        
        // Фильтрация жалоб
        function filterComplaints(filter) {
            document.querySelectorAll('#complaints-tab .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadComplaintsForAdmin(filter);
        }
        
        // Взять жалобу в работу
        async function assignComplaint(complaintId) {
            try {
                await database.ref(`complaints/${complaintId}`).update({
                    status: 'in-progress',
                    assignedTo: appData.currentUserId,
                    assignedToName: appData.currentUserData?.first_name || 'Администратор',
                    assignedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                await createAdminLog(
                    'assign_complaint',
                    `Взята в работу жалоба ${complaintId}`,
                    appData.currentUserId
                );
                
                showNotification('Жалоба взята в работу', 'success');
                loadComplaintsForAdmin();
                
            } catch (error) {
                showNotification('Ошибка', 'error');
            }
        }
        
        // Загрузить аналитику
        async function loadAnalytics() {
            try {
                // Получаем статистику
                const stats = await FirebaseMarketServer.getStats();
                
                // Получаем жалобы
                const complaintsSnapshot = await database.ref('complaints').once('value');
                const totalComplaints = complaintsSnapshot.numChildren();
                
                // Получаем заблокированных пользователей
                const blockedSnapshot = await database.ref('blockedUsers').once('value');
                const blockedUsers = blockedSnapshot.numChildren();
                
                // Обновляем UI
                document.getElementById('total-users').textContent = stats.totalUsers;
                document.getElementById('total-ads').textContent = stats.totalAds;
                document.getElementById('total-complaints').textContent = totalComplaints;
                document.getElementById('blocked-users').textContent = blockedUsers;
                
                // TODO: Загрузить график активности
                
            } catch (error) {
                console.error('Ошибка загрузки аналитики:', error);
            }
        }
        
        // Загрузить логи
        async function loadAdminLogs() {
            try {
                const logsRef = database.ref('adminLogs').orderByChild('timestamp').limitToLast(50);
                const snapshot = await logsRef.once('value');
                const logs = [];
                
                snapshot.forEach((childSnapshot) => {
                    logs.unshift(childSnapshot.val()); // Новые сверху
                });
                
                const container = document.getElementById('admin-logs');
                container.innerHTML = '';
                
                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px; color: #D8B4FE;">Логи отсутствуют</div>';
                    return;
                }
                
                logs.forEach(log => {
                    const time = new Date(log.timestamp).toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const logElement = document.createElement('div');
                    logElement.className = 'log-item';
                    
                    logElement.innerHTML = `
                        <div class="log-header">
                            <div class="log-user">${log.adminName || 'Система'}</div>
                            <div class="log-time">${time}</div>
                        </div>
                        <div class="log-action">${log.action}</div>
                        ${log.reason ? `<div class="log-reason">Причина: ${log.reason}</div>` : ''}
                    `;
                    
                    container.appendChild(logElement);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки логов:', error);
            }
        }
        
        // ==================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================
        
        // Создать лог админа
        async function createAdminLog(actionType, action, adminId, reason = '') {
            try {
                const logRef = database.ref('adminLogs').push();
                
                await logRef.set({
                    id: logRef.key,
                    actionType: actionType,
                    action: action,
                    adminId: adminId,
                    adminName: appData.currentUserData?.first_name || 'Система',
                    reason: reason,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
            } catch (error) {
                console.error('Ошибка создания лога:', error);
            }
        }
        
        // Получить текст статуса жалобы
        function getComplaintStatusText(status) {
            const statuses = {
                'new': 'Новая',
                'in-progress': 'В работе',
                'resolved': 'Решена',
                'rejected': 'Отклонена'
            };
            return statuses[status] || status;
        }
        
        // Получить текст типа жалобы
        function getComplaintTypeText(type) {
            const types = {
                'scam': 'Мошенничество',
                'spam': 'Спам',
                'offensive': 'Оскорбления',
                'inappropriate': 'Неуместный контент',
                'fake': 'Фейковое объявление',
                'other': 'Другое'
            };
            return types[type] || type;
        }
        
        // Уведомить админов (заглушка)
        function notifyAdmins(title, message) {
            console.log(`📢 Уведомление админам: ${title} - ${message}`);
            // Здесь можно реализовать отправку уведомлений через Telegram API
        }
        
        // ==================== ИНТЕГРАЦИЯ С ВАШИМ СУЩЕСТВУЮЩИМ КОДОМ ====================
        
        // Модифицируем функцию checkTelegramAndInit для включения проверки блокировки
        function checkTelegramAndInit() {
            console.log('🔍 Начинаем инициализацию...');
            
            // Пробуем получить Telegram Web App
            const tg = window.Telegram?.WebApp;
            
            if (tg) {
                console.log('✅ Telegram Web App обнаружен');
                
                // Расширяем на весь экран
                tg.expand();
                tg.ready();
                
                // Показываем кнопку "Назад"
                tg.BackButton.show();
                tg.BackButton.onClick(function() {
                    tg.close();
                });
                
                // Получаем данные пользователя
                const user = tg.initDataUnsafe?.user;
                console.log('Данные пользователя из Telegram:', user);
                
                if (user && user.id) {
                    console.log('✅ Пользователь Telegram получен');
                    appData.currentUserId = user.id.toString();
                    appData.currentUserData = {
                        id: user.id,
                        first_name: user.first_name || 'Пользователь',
                        last_name: user.last_name || '',
                        username: user.username || '',
                        photo_url: user.photo_url || null
                    };
                    
                    // Сначала проверяем статус пользователя (блокировка/права)
                    checkUserStatus().then(() => {
                        // Только если не заблокирован, регистрируем и запускаем
                        if (!appData.isBlocked) {
                            FirebaseMarketServer.registerUser(appData.currentUserData)
                                .then(success => {
                                    console.log('Регистрация в Firebase:', success ? '✅ Успешно' : '❌ Ошибка');
                                    initApp();
                                })
                                .catch(error => {
                                    console.error('Ошибка регистрации в Firebase:', error);
                                    initApp(); // Все равно запускаем приложение
                                });
                        }
                    });
                    
                } else {
                    console.warn('⚠️ Нет данных пользователя в Telegram');
                    createTestUser();
                }
            } else {
                console.warn('⚠️ Telegram Web App не найден (открыто в браузере)');
                createTestUser();
            }
            
            // Функция создания тестового пользователя
            function createTestUser() {
                appData.currentUserId = 'test_user_' + Date.now();
                appData.currentUserData = {
                    id: appData.currentUserId,
                    first_name: 'Тестовый',
                    username: 'testuser_' + Math.floor(Math.random() * 1000),
                    photo_url: null
                };
                
                console.log('🔄 Создан тестовый пользователь:', appData.currentUserData);
                
                // Проверяем статус тестового пользователя
                checkUserStatus().then(() => {
                    if (!appData.isBlocked) {
                        FirebaseMarketServer.registerUser(appData.currentUserData)
                            .then(success => {
                                console.log('Регистрация тестового пользователя:', success ? '✅ Успешно' : '❌ Ошибка');
                                initApp();
                            })
                            .catch(error => {
                                console.error('Ошибка регистрации тестового пользователя:', error);
                                initApp();
                            });
                    }
                });
            }
        }
        
        // Модифицируем функцию renderAds для добавления кнопки жалобы
        // Нужно добавить кнопку жалобы в карточку объявления
        // Для этого мы немного модифицируем HTML генерацию в renderAds
        
        // Создаем функцию для добавления кнопки жалобы в карточку
        function addReportButtonToAd(adElement, ad) {
            // Создаем кнопку жалобы
            const reportBtn = document.createElement('button');
            reportBtn.className = 'report-seller-btn';
            reportBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            reportBtn.title = 'Пожаловаться на продавца';
            reportBtn.onclick = (e) => {
                e.stopPropagation();
                openComplaintModal(ad.sellerId, ad.sellerName, ad.id);
            };
            
            // Добавляем кнопку в заголовок продавца
            const sellerHeader = adElement.querySelector('.seller-header');
            if (sellerHeader) {
                sellerHeader.style.position = 'relative';
                sellerHeader.appendChild(reportBtn);
            }
        }
        
        // Модифицируем конец функции renderAds (после adElement.innerHTML = `...`)
        // Найдем строку в вашем коде где создается adElement и добавим после:
        // container.appendChild(adElement);
        
        // Добавим после этой строки:
        // addReportButtonToAd(adElement, ad);
        
        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        
        // Запуск при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            checkTelegramAndInit();
            
            // Слушаем жалобы в реальном времени для обновления счетчика
            database.ref('complaints').on('value', (snapshot) => {
                updateComplaintsCount();
            });
        });
        
        // Закрытие модальных окон по клику на фон
        document.getElementById('complaintModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeComplaintModal();
            }
        });
        
        document.getElementById('blockUserModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeBlockModal();
            }
        });
        
        // ==================== ВАШ СУЩЕСТВУЮЩИЙ КОД НИЖЕ (без изменений) ====================
        // ... [Весь ваш существующий код функций, начиная с initApp() и ниже] ...
        // Я сохранил все ваши функции без изменений, добавив только интеграционные моменты выше
        
        // Здесь должен быть весь ваш оставшийся код, который я не стал дублировать
        // чтобы не делать ответ слишком большим
        
    </script>
    
    <!-- Вставьте сюда весь ваш оставшийся JavaScript код -->
    <!-- Все функции начиная с initApp() и до конца -->
    
</body>
</html>
